<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cotizador con Preview - SUBE IA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #00B8D9;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .btn {
      background: linear-gradient(135deg, #00B8D9, #FF4EFF);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .btn-secondary {
      background: #6c757d;
    }
    .btn-success {
      background: #28a745;
    }
    .result {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success { background: #d4edda; color: #155724; }
    .error { color: #721c24; }
    
    /* Modal de previsualizaci√≥n */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
    }
    .modal-content {
      background-color: white;
      margin: 2% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #00B8D9;
    }
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: #000;
    }
    .preview-content {
      background: white;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .modal-buttons .btn {
      width: auto;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÑ Cotizador con Preview - SUBE IA TECH</h1>
      <p>Previsualiza antes de generar el PDF</p>
    </div>
    
    <form id="cotizador-form">
      <div class="form-group">
        <label for="nombre">Nombre completo *</label>
        <input type="text" id="nombre" required value="Cliente Test">
      </div>
      
      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email" id="email" required value="test@example.com">
      </div>
      
      <div class="form-group">
        <label for="empresa">Empresa *</label>
        <input type="text" id="empresa" required value="Empresa Test SPA">
      </div>
      
      <div class="form-group">
        <label for="servicio">Servicio *</label>
        <select id="servicio" required>
          <option value="Charlas">Charlas</option>
          <option value="Capacitaciones">Capacitaciones</option>
          <option value="Consultor√≠as">Consultor√≠as</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="detalle">Detalle del servicio *</label>
        <textarea id="detalle" rows="3" required>Presentaci√≥n sobre Inteligencia Artificial para el equipo de desarrollo</textarea>
      </div>
      
      <div class="form-group">
        <label for="valor">Valor *</label>
        <input type="number" id="valor" min="0" step="0.01" required value="50000">
      </div>
      
      <div class="form-group">
        <label for="descuento">Descuento (%)</label>
        <input type="number" id="descuento" min="0" max="100" step="0.01" value="10">
      </div>
      
      <button type="submit" class="btn" id="generar-btn">
        üëÅÔ∏è Previsualizar Cotizaci√≥n
      </button>
    </form>
    
    <div id="result" class="result" style="display: none;"></div>
  </div>

  <!-- Modal de previsualizaci√≥n -->
  <div id="previewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">üìã Previsualizaci√≥n de Cotizaci√≥n</span>
        <span class="close" onclick="cerrarModal()">&times;</span>
      </div>
      <div id="previewContent" class="preview-content">
        <!-- Aqu√≠ se mostrar√° la previsualizaci√≥n -->
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="cerrarModal()">‚ùå Cancelar</button>
        <button class="btn btn-success" onclick="generarPDFFinal()">üìÑ Generar PDF</button>
      </div>
    </div>
  </div>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script>
    let datosCotizacionActual = null;

    // Funci√≥n para mostrar resultado
    function mostrarResultado(mensaje, tipo = 'info') {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = mensaje;
      resultDiv.className = `result ${tipo}`;
      resultDiv.style.display = 'block';
    }

    // Funci√≥n para generar c√≥digo √∫nico
    function generarCodigo() {
      const timestamp = Date.now();
      return `SUBEIA-${String(timestamp).slice(-6)}`;
    }

    // Funci√≥n para crear HTML de la cotizaci√≥n
    function crearHTMLCotizacion(datos) {
      return `
        <div style="font-family: Arial, sans-serif; background: white; color: black; padding: 20px; max-width: 800px; margin: 0 auto;">
          <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #00B8D9; padding-bottom: 20px;">
            <h1 style="color: #00B8D9; margin: 0; font-size: 24px;">SUBE IA TECH</h1>
            <h2 style="color: #333; margin: 10px 0; font-size: 18px;">Cotizaci√≥n de Servicios</h2>
            <p style="color: #666; margin: 5px 0; font-size: 12px;">Fco. Mansilla 1007, Castro, Chile</p>
            <p style="color: #666; margin: 5px 0; font-size: 12px;">RUT: 77.994.591-K | contacto@subeia.tech</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
              <div style="flex: 1; margin-right: 20px;">
                <h3 style="color: #333; margin: 0 0 10px 0; font-size: 16px;">Datos del Cliente</h3>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Nombre:</strong> ${datos.nombre}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Email:</strong> ${datos.email}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Empresa:</strong> ${datos.empresa}</p>
              </div>
              <div style="flex: 1;">
                <h3 style="color: #333; margin: 0 0 10px 0; font-size: 16px;">Informaci√≥n de Cotizaci√≥n</h3>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Fecha:</strong> ${datos.fecha}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>C√≥digo:</strong> ${datos.codigo}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Moneda:</strong> ${datos.moneda}</p>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px; font-size: 16px;">Servicios Cotizados</h3>
            <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 5px; background: #f9f9f9;">
              <h4 style="color: #00B8D9; margin: 0 0 10px 0; font-size: 14px;">${datos.servicio}</h4>
              <p style="margin: 5px 0; font-size: 12px;"><strong>Detalle:</strong> ${datos.detalle}</p>
              <p style="margin: 5px 0; font-weight: bold; color: #1976d2; font-size: 12px;"><strong>Subtotal:</strong> ${datos.valor.toLocaleString()} ${datos.moneda}</p>
            </div>
          </div>
          
          <div style="border-top: 2px solid #00B8D9; padding-top: 20px; margin-top: 30px;">
            <div style="text-align: right;">
              <h3 style="color: #333; margin: 0; font-size: 14px;">Subtotal: ${datos.valor.toLocaleString()} ${datos.moneda}</h3>
              ${datos.descuento > 0 ? `<h4 style="color: #FF4EFF; margin: 10px 0; font-size: 12px;">Descuento (${datos.descuento}%): -${datos.descuentoValor.toLocaleString()} ${datos.moneda}</h4>` : ''}
              <h2 style="color: #00B8D9; margin: 10px 0; font-size: 18px;">Total: ${datos.totalConDescuento.toLocaleString()} ${datos.moneda}</h2>
            </div>
          </div>
          
          <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 10px;">
            <p style="margin: 5px 0;"><strong>V√°lido 15 d√≠as</strong></p>
            <p style="margin: 5px 0;">Condiciones de pago: 50% al aceptar, 50% contra entrega</p>
            <p style="margin: 5px 0;">Consultas: contacto@subeia.tech</p>
          </div>
        </div>
      `;
    }

    // Funci√≥n para mostrar previsualizaci√≥n
    function mostrarPrevisualizacion(datos) {
      const modal = document.getElementById('previewModal');
      const previewContent = document.getElementById('previewContent');
      
      // Crear el HTML de la cotizaci√≥n
      const html = crearHTMLCotizacion(datos);
      previewContent.innerHTML = html;
      
      // Mostrar el modal
      modal.style.display = 'block';
      
      // Guardar los datos para usar en la generaci√≥n del PDF
      datosCotizacionActual = datos;
    }

    // Funci√≥n para cerrar modal
    function cerrarModal() {
      const modal = document.getElementById('previewModal');
      modal.style.display = 'none';
    }

    // Funci√≥n para generar PDF final (corregido)
    function generarPDFFinal() {
      if (!datosCotizacionActual) {
        mostrarResultado('‚ùå No hay datos de cotizaci√≥n para generar PDF', 'error');
        return;
      }

      console.log('Generando PDF final con datos:', datosCotizacionActual);
      mostrarResultado('üìÑ Generando PDF...', 'info');
      
      // Crear el HTML del PDF
      const html = crearHTMLCotizacion(datosCotizacionActual);
      
      console.log('HTML generado:', html);
      
      // Crear elemento temporal
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      tempDiv.style.position = 'absolute';
      tempDiv.style.left = '-9999px';
      tempDiv.style.top = '0';
      tempDiv.style.width = '210mm';
      tempDiv.style.backgroundColor = 'white';
      tempDiv.style.padding = '20mm';
      tempDiv.style.zIndex = '-1';
      
      document.body.appendChild(tempDiv);
      console.log('Elemento temporal creado y a√±adido al DOM');
      
      // Configuraci√≥n corregida para PDF
      const opt = {
        margin: [10, 10, 10, 10],
        filename: `${datosCotizacionActual.codigo}_cotizacion.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: 794, // A4 width in pixels at 96 DPI
          height: 1123 // A4 height in pixels at 96 DPI
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait'
        }
      };
      
      console.log('Configuraci√≥n html2pdf:', opt);
      
      // Generar PDF
      try {
        html2pdf().set(opt).from(tempDiv).save()
          .then(() => {
            console.log('PDF generado exitosamente');
            document.body.removeChild(tempDiv);
            mostrarResultado(`‚úÖ PDF generado exitosamente: ${datosCotizacionActual.codigo}_cotizacion.pdf`, 'success');
            cerrarModal();
          })
          .catch((error) => {
            console.error('Error en html2pdf:', error);
            if (document.body.contains(tempDiv)) {
              document.body.removeChild(tempDiv);
            }
            mostrarResultado(`‚ùå Error generando PDF: ${error.message}`, 'error');
          });
      } catch (error) {
        console.error('Error general en PDF:', error);
        if (document.body.contains(tempDiv)) {
          document.body.removeChild(tempDiv);
        }
        mostrarResultado(`‚ùå Error general: ${error.message}`, 'error');
      }
    }

    // Funci√≥n principal para procesar el formulario
    function procesarCotizacion(event) {
      event.preventDefault();
      console.log('Procesando cotizaci√≥n...');
      
      const btn = document.getElementById('generar-btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Procesando...';
      
      try {
        // Recopilar datos del formulario
        const nombre = document.getElementById('nombre').value.trim();
        const email = document.getElementById('email').value.trim();
        const empresa = document.getElementById('empresa').value.trim();
        const servicio = document.getElementById('servicio').value;
        const detalle = document.getElementById('detalle').value.trim();
        const valor = parseFloat(document.getElementById('valor').value || '0');
        const descuento = parseFloat(document.getElementById('descuento').value || '0');
        
        console.log('Datos recopilados:', { nombre, email, empresa, servicio, detalle, valor, descuento });
        
        // Validar campos requeridos
        if (!nombre || !email || !empresa || !servicio || !detalle || valor <= 0) {
          throw new Error('Por favor, completa todos los campos requeridos con valores v√°lidos.');
        }
        
        // Calcular descuento
        const descuentoValor = valor * (descuento / 100);
        const totalConDescuento = valor - descuentoValor;
        
        // Crear objeto de datos
        const datosCotizacion = {
          codigo: generarCodigo(),
          nombre,
          email,
          empresa,
          servicio,
          detalle,
          valor,
          descuento,
          descuentoValor,
          totalConDescuento,
          moneda: 'CLP',
          fecha: new Date().toLocaleDateString('es-CL')
        };
        
        console.log('Datos de cotizaci√≥n:', datosCotizacion);
        mostrarResultado('‚úÖ Datos validados correctamente', 'success');
        
        // Mostrar previsualizaci√≥n
        setTimeout(() => {
          mostrarPrevisualizacion(datosCotizacion);
        }, 500);
        
      } catch (error) {
        console.error('Error en procesamiento:', error);
        mostrarResultado(`‚ùå Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üëÅÔ∏è Previsualizar Cotizaci√≥n';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM cargado, configurando event listeners...');
      
      // Event listener para el formulario del cotizador
      const form = document.getElementById('cotizador-form');
      if (form) {
        form.addEventListener('submit', procesarCotizacion);
        console.log('Event listener del formulario configurado');
      } else {
        console.error('Formulario no encontrado');
      }
      
      // Verificar html2pdf
      if (typeof html2pdf !== 'undefined') {
        console.log('‚úÖ html2pdf disponible');
      } else {
        console.error('‚ùå html2pdf NO disponible');
      }
      
      console.log('‚úÖ Cotizador con preview inicializado');
    });

    // Cerrar modal al hacer clic fuera de √©l
    window.onclick = function(event) {
      const modal = document.getElementById('previewModal');
      if (event.target === modal) {
        cerrarModal();
      }
    }
  </script>
</body>
</html> 