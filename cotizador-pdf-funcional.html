<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cotizador PDF Funcional - SUBE IA</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #00B8D9;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .btn {
      background: linear-gradient(135deg, #00B8D9, #FF4EFF);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .result {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success { background: #d4edda; color: #155724; }
    .error { color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📄 Cotizador PDF Funcional - SUBE IA TECH</h1>
      <p>Versión que SÍ genera PDFs con contenido</p>
    </div>
    
    <form id="cotizador-form">
      <div class="form-group">
        <label for="nombre">Nombre completo *</label>
        <input type="text" id="nombre" required value="Cliente Test">
      </div>
      
      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email" id="email" required value="test@example.com">
      </div>
      
      <div class="form-group">
        <label for="empresa">Empresa *</label>
        <input type="text" id="empresa" required value="Empresa Test SPA">
      </div>
      
      <div class="form-group">
        <label for="servicio">Servicio *</label>
        <select id="servicio" required>
          <option value="Charlas">Charlas</option>
          <option value="Capacitaciones">Capacitaciones</option>
          <option value="Consultorías">Consultorías</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="detalle">Detalle del servicio *</label>
        <textarea id="detalle" rows="3" required>Presentación sobre Inteligencia Artificial para el equipo de desarrollo</textarea>
      </div>
      
      <div class="form-group">
        <label for="valor">Valor *</label>
        <input type="number" id="valor" min="0" step="0.01" required value="50000">
      </div>
      
      <div class="form-group">
        <label for="descuento">Descuento (%)</label>
        <input type="number" id="descuento" min="0" max="100" step="0.01" value="10">
      </div>
      
      <button type="submit" class="btn" id="generar-btn">
        🚀 Generar Cotización y PDF
      </button>
    </form>
    
    <div id="result" class="result" style="display: none;"></div>
  </div>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script>
    // Función para mostrar resultado
    function mostrarResultado(mensaje, tipo = 'info') {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = mensaje;
      resultDiv.className = `result ${tipo}`;
      resultDiv.style.display = 'block';
    }

    // Función para generar código único
    function generarCodigo() {
      const timestamp = Date.now();
      return `SUBEIA-${String(timestamp).slice(-6)}`;
    }

    // Función para generar PDF (SOLUCIÓN DEFINITIVA)
    function generarPDF(datos) {
      console.log('Generando PDF con datos:', datos);
      mostrarResultado('📄 Generando PDF...', 'info');
      
      // Crear el HTML del PDF con estilos inline
      const html = `
        <div style="font-family: Arial, sans-serif; background: white; color: black; padding: 20px; max-width: 800px; margin: 0 auto;">
          <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #00B8D9; padding-bottom: 20px;">
            <h1 style="color: #00B8D9; margin: 0; font-size: 24px;">SUBE IA TECH</h1>
            <h2 style="color: #333; margin: 10px 0; font-size: 18px;">Cotización de Servicios</h2>
            <p style="color: #666; margin: 5px 0; font-size: 12px;">Fco. Mansilla 1007, Castro, Chile</p>
            <p style="color: #666; margin: 5px 0; font-size: 12px;">RUT: 77.994.591-K | contacto@subeia.tech</p>
          </div>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
              <div style="flex: 1; margin-right: 20px;">
                <h3 style="color: #333; margin: 0 0 10px 0; font-size: 16px;">Datos del Cliente</h3>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Nombre:</strong> ${datos.nombre}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Email:</strong> ${datos.email}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Empresa:</strong> ${datos.empresa}</p>
              </div>
              <div style="flex: 1;">
                <h3 style="color: #333; margin: 0 0 10px 0; font-size: 16px;">Información de Cotización</h3>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Fecha:</strong> ${datos.fecha}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Código:</strong> ${datos.codigo}</p>
                <p style="margin: 5px 0; font-size: 12px;"><strong>Moneda:</strong> ${datos.moneda}</p>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px; font-size: 16px;">Servicios Cotizados</h3>
            <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 5px; background: #f9f9f9;">
              <h4 style="color: #00B8D9; margin: 0 0 10px 0; font-size: 14px;">${datos.servicio}</h4>
              <p style="margin: 5px 0; font-size: 12px;"><strong>Detalle:</strong> ${datos.detalle}</p>
              <p style="margin: 5px 0; font-weight: bold; color: #1976d2; font-size: 12px;"><strong>Subtotal:</strong> ${datos.valor.toLocaleString()} ${datos.moneda}</p>
            </div>
          </div>
          
          <div style="border-top: 2px solid #00B8D9; padding-top: 20px; margin-top: 30px;">
            <div style="text-align: right;">
              <h3 style="color: #333; margin: 0; font-size: 14px;">Subtotal: ${datos.valor.toLocaleString()} ${datos.moneda}</h3>
              ${datos.descuento > 0 ? `<h4 style="color: #FF4EFF; margin: 10px 0; font-size: 12px;">Descuento (${datos.descuento}%): -${datos.descuentoValor.toLocaleString()} ${datos.moneda}</h4>` : ''}
              <h2 style="color: #00B8D9; margin: 10px 0; font-size: 18px;">Total: ${datos.totalConDescuento.toLocaleString()} ${datos.moneda}</h2>
            </div>
          </div>
          
          <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 10px;">
            <p style="margin: 5px 0;"><strong>Válido 15 días</strong></p>
            <p style="margin: 5px 0;">Condiciones de pago: 50% al aceptar, 50% contra entrega</p>
            <p style="margin: 5px 0;">Consultas: contacto@subeia.tech</p>
          </div>
        </div>
      `;
      
      console.log('HTML generado:', html);
      
      // Crear elemento temporal VISIBLE (esto es clave)
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      tempDiv.style.position = 'fixed';
      tempDiv.style.top = '0';
      tempDiv.style.left = '0';
      tempDiv.style.width = '210mm';
      tempDiv.style.height = '297mm';
      tempDiv.style.backgroundColor = 'white';
      tempDiv.style.padding = '20mm';
      tempDiv.style.zIndex = '9999';
      tempDiv.style.transform = 'scale(0.5)';
      tempDiv.style.transformOrigin = 'top left';
      tempDiv.style.overflow = 'hidden';
      
      // Añadir al DOM
      document.body.appendChild(tempDiv);
      console.log('Elemento temporal creado y añadido al DOM');
      
      // Esperar un momento para que se renderice
      setTimeout(() => {
        // Configuración optimizada para evitar PDFs en blanco
        const opt = {
          margin: 0,
          filename: `${datos.codigo}_cotizacion.pdf`,
          image: { type: 'jpeg', quality: 1 },
          html2canvas: { 
            scale: 1,
            useCORS: false,
            allowTaint: true,
            backgroundColor: '#ffffff',
            width: 210 * 3.779527559, // Convertir mm a px
            height: 297 * 3.779527559,
            scrollX: 0,
            scrollY: 0
          },
          jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            compress: false
          }
        };
        
        console.log('Configuración html2pdf:', opt);
        console.log('Verificando html2pdf:', typeof html2pdf);
        
        // Generar PDF
        try {
          html2pdf().set(opt).from(tempDiv).save()
            .then(() => {
              console.log('PDF generado exitosamente');
              document.body.removeChild(tempDiv);
              mostrarResultado(`✅ PDF generado exitosamente: ${datos.codigo}_cotizacion.pdf`, 'success');
            })
            .catch((error) => {
              console.error('Error en html2pdf:', error);
              if (document.body.contains(tempDiv)) {
                document.body.removeChild(tempDiv);
              }
              mostrarResultado(`❌ Error generando PDF: ${error.message}`, 'error');
            });
        } catch (error) {
          console.error('Error general en PDF:', error);
          if (document.body.contains(tempDiv)) {
            document.body.removeChild(tempDiv);
          }
          mostrarResultado(`❌ Error general: ${error.message}`, 'error');
        }
      }, 1000); // Esperar 1 segundo para que se renderice
    }

    // Función principal para procesar el formulario
    function procesarCotizacion(event) {
      event.preventDefault();
      console.log('Procesando cotización...');
      
      const btn = document.getElementById('generar-btn');
      btn.disabled = true;
      btn.textContent = '⏳ Procesando...';
      
      try {
        // Recopilar datos del formulario
        const nombre = document.getElementById('nombre').value.trim();
        const email = document.getElementById('email').value.trim();
        const empresa = document.getElementById('empresa').value.trim();
        const servicio = document.getElementById('servicio').value;
        const detalle = document.getElementById('detalle').value.trim();
        const valor = parseFloat(document.getElementById('valor').value || '0');
        const descuento = parseFloat(document.getElementById('descuento').value || '0');
        
        console.log('Datos recopilados:', { nombre, email, empresa, servicio, detalle, valor, descuento });
        
        // Validar campos requeridos
        if (!nombre || !email || !empresa || !servicio || !detalle || valor <= 0) {
          throw new Error('Por favor, completa todos los campos requeridos con valores válidos.');
        }
        
        // Calcular descuento
        const descuentoValor = valor * (descuento / 100);
        const totalConDescuento = valor - descuentoValor;
        
        // Crear objeto de datos
        const datosCotizacion = {
          codigo: generarCodigo(),
          nombre,
          email,
          empresa,
          servicio,
          detalle,
          valor,
          descuento,
          descuentoValor,
          totalConDescuento,
          moneda: 'CLP',
          fecha: new Date().toLocaleDateString('es-CL')
        };
        
        console.log('Datos de cotización:', datosCotizacion);
        mostrarResultado('✅ Datos validados correctamente', 'success');
        
        // Generar PDF
        setTimeout(() => {
          generarPDF(datosCotizacion);
        }, 500);
        
      } catch (error) {
        console.error('Error en procesamiento:', error);
        mostrarResultado(`❌ Error: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '🚀 Generar Cotización y PDF';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM cargado, configurando event listeners...');
      
      // Event listener para el formulario del cotizador
      const form = document.getElementById('cotizador-form');
      if (form) {
        form.addEventListener('submit', procesarCotizacion);
        console.log('Event listener del formulario configurado');
      } else {
        console.error('Formulario no encontrado');
      }
      
      // Verificar html2pdf
      if (typeof html2pdf !== 'undefined') {
        console.log('✅ html2pdf disponible');
      } else {
        console.error('❌ html2pdf NO disponible');
      }
      
      console.log('✅ Cotizador PDF funcional inicializado');
    });
  </script>
</body>
</html> 